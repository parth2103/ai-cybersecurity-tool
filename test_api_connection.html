<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üöÄ AI Cybersecurity Tool - API Connection Test</h1>
    
    <div class="test-section">
        <h2>üîó API Connection Tests</h2>
        <button onclick="testHealth()">Test Health Endpoint</button>
        <button onclick="testStats()">Test Stats Endpoint</button>
        <button onclick="testSystemInfo()">Test System Info</button>
        <button onclick="testThreatDetection()">Test Threat Detection</button>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>üìä Live System Status</h2>
        <div id="liveStatus">Click "Test Health Endpoint" to start</div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        const API_KEY = 'dev-key-123';
        const ADMIN_KEY = 'admin-key-789';

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            results.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function updateLiveStatus(data) {
            document.getElementById('liveStatus').innerHTML = `
                <div class="success">‚úÖ API Status: ${data.status}</div>
                <div class="info">üïê Timestamp: ${data.timestamp}</div>
            `;
        }

        async function testHealth() {
            log('Testing API health endpoint...');
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Health check successful: ${data.status}`, 'success');
                    updateLiveStatus(data);
                } else {
                    log(`‚ùå Health check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Health check error: ${error.message}`, 'error');
            }
        }

        async function testStats() {
            log('Testing stats endpoint with API key...');
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Stats retrieved successfully`, 'success');
                    log(`üìä Total requests: ${data.total_requests}`);
                    log(`üö® Threats detected: ${data.threats_detected}`);
                    log(`üìà Current threat level: ${data.current_threat_level}`);
                } else {
                    log(`‚ùå Stats request failed: ${response.status} - ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Stats request error: ${error.message}`, 'error');
            }
        }

        async function testSystemInfo() {
            log('Testing system info endpoint with admin key...');
            try {
                const response = await fetch(`${API_BASE}/system/info`, {
                    headers: {
                        'X-API-Key': ADMIN_KEY
                    }
                });
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ System info retrieved successfully`, 'success');
                    log(`üñ•Ô∏è CPU Usage: ${data.cpu_percent}%`);
                    log(`üíæ Memory Usage: ${data.memory_percent}%`);
                    log(`üíΩ Disk Usage: ${data.disk_usage}%`);
                    log(`ü§ñ Models loaded: ${data.models_loaded.join(', ')}`);
                } else {
                    log(`‚ùå System info request failed: ${response.status} - ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå System info request error: ${error.message}`, 'error');
            }
        }

        async function testThreatDetection() {
            log('Testing threat detection endpoint...');
            
            const threatData = {
                features: {
                    "Destination Port": 80,
                    "Flow Duration": 1000,
                    "Total Fwd Packets": 10,
                    "Total Backward Packets": 8,
                    "Total Length of Fwd Packets": 1000,
                    "Total Length of Bwd Packets": 800,
                    "Fwd Packet Length Max": 100,
                    "Fwd Packet Length Min": 90,
                    "Fwd Packet Length Mean": 95,
                    "Fwd Packet Length Std": 5,
                    "Bwd Packet Length Max": 100,
                    "Bwd Packet Length Min": 90,
                    "Bwd Packet Length Mean": 95,
                    "Bwd Packet Length Std": 5,
                    "Flow Bytes/s": 1000,
                    "Flow Packets/s": 10,
                    "Flow IAT Mean": 100,
                    "Flow IAT Std": 10,
                    "Flow IAT Max": 120,
                    "Flow IAT Min": 80,
                    "Fwd IAT Total": 1000,
                    "Fwd IAT Mean": 100,
                    "Fwd IAT Std": 10,
                    "Fwd IAT Max": 120,
                    "Fwd IAT Min": 80,
                    "Bwd IAT Total": 800,
                    "Bwd IAT Mean": 100,
                    "Bwd IAT Std": 10,
                    "Bwd IAT Max": 120,
                    "Bwd IAT Min": 80,
                    "Fwd PSH Flags": 0,
                    "Bwd PSH Flags": 0,
                    "Fwd URG Flags": 0,
                    "Bwd URG Flags": 0,
                    "Fwd Header Length": 20,
                    "Bwd Header Length": 20,
                    "Fwd Packets/s": 5,
                    "Bwd Packets/s": 4,
                    "Min Packet Length": 90,
                    "Max Packet Length": 100,
                    "Packet Length Mean": 95,
                    "Packet Length Std": 5,
                    "Packet Length Variance": 25,
                    "FIN Flag Count": 0,
                    "SYN Flag Count": 1,
                    "RST Flag Count": 0,
                    "PSH Flag Count": 0,
                    "ACK Flag Count": 1,
                    "URG Flag Count": 0,
                    "CWE Flag Count": 0,
                    "ECE Flag Count": 0,
                    "Down/Up Ratio": 0.8,
                    "Average Packet Size": 95,
                    "Avg Fwd Segment Size": 95,
                    "Avg Bwd Segment Size": 95,
                    "Fwd Header Length.1": 20,
                    "Fwd Avg Bytes/Bulk": 0,
                    "Fwd Avg Packets/Bulk": 0,
                    "Fwd Avg Bulk Rate": 0,
                    "Bwd Avg Bytes/Bulk": 0,
                    "Bwd Avg Packets/Bulk": 0,
                    "Bwd Avg Bulk Rate": 0,
                    "Subflow Fwd Packets": 10,
                    "Subflow Fwd Bytes": 1000,
                    "Subflow Bwd Packets": 8,
                    "Subflow Bwd Bytes": 800,
                    "Init_Win_bytes_forward": 65535,
                    "Init_Win_bytes_backward": 65535,
                    "act_data_pkt_fwd": 0,
                    "min_seg_size_forward": 0,
                    "Active Mean": 0,
                    "Active Std": 0,
                    "Active Max": 0,
                    "Active Min": 0,
                    "Idle Mean": 0,
                    "Idle Std": 0,
                    "Idle Max": 0,
                    "Idle Min": 0
                },
                source_ip: "192.168.1.100",
                attack_type: "Benign"
            };

            try {
                const response = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify(threatData)
                });
                const data = await response.json();
                
                if (response.ok) {
                    log(`‚úÖ Threat detection successful`, 'success');
                    log(`üéØ Threat Score: ${data.threat_score} (${(data.threat_score * 100).toFixed(1)}%)`);
                    log(`üö® Threat Level: ${data.threat_level}`);
                    log(`‚ö° Processing Time: ${data.processing_time_ms}ms`);
                    log(`ü§ñ Threat Detected: ${data.threat_detected ? 'Yes' : 'No'}`);
                } else {
                    log(`‚ùå Threat detection failed: ${response.status} - ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Threat detection error: ${error.message}`, 'error');
            }
        }

        // Auto-refresh live status every 5 seconds
        setInterval(testHealth, 5000);
        
        // Initial test
        testHealth();
    </script>
</body>
</html>
